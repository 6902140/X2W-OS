\hypertarget{strap_8h}{}\doxysection{/home/data/proj/oskernel2023-\/x2w/include/sbi/strap.h 文件参考}
\label{strap_8h}\index{/home/data/proj/oskernel2023-\/x2w/include/sbi/strap.h@{/home/data/proj/oskernel2023-\/x2w/include/sbi/strap.h}}


{\ttfamily \mbox{\hyperlink{strap_8h}{strap.\+h}}}是{\ttfamily S\+BI}的异常/中断管理模块  


{\ttfamily \#include \char`\"{}types.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}constrains.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}trap/trapframe.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}trap/trap\+\_\+entry.\+h\char`\"{}}\newline
\doxysubsection*{类型定义}
\begin{DoxyCompactItemize}
\item 
typedef \mbox{\hyperlink{types_8h_a312c7e8848187d110315ab83a7b3d4d0}{int64\+\_\+t}}($\ast$ \mbox{\hyperlink{strap_8h_a9a19fa750573209f5634e474b11a3ee3}{strap\+\_\+handler\+\_\+t}}) (\mbox{\hyperlink{trapframe_8h_ace23faaa1579bcc09327b838e4f18145}{strapframe\+\_\+t}} $\ast$stf\+\_\+ptr)
\begin{DoxyCompactList}\small\item\em {\ttfamily strap\+\_\+handler\+\_\+t}是异常/中断处理函数的函数类型, 函数原型为\+: {\ttfamily int64\+\_\+t funcname(struct strapframe\+\_\+t$\ast$)} \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsection*{函数}
\begin{DoxyCompactItemize}
\item 
\mbox{\Hypertarget{strap_8h_a7cd9fe16e6c323ee6338df4ff08d35a0}\label{strap_8h_a7cd9fe16e6c323ee6338df4ff08d35a0}} 
void \mbox{\hyperlink{strap_8h_a7cd9fe16e6c323ee6338df4ff08d35a0}{strap\+\_\+init}} (void)
\begin{DoxyCompactList}\small\item\em {\ttfamily strap\+\_\+init}是{\ttfamily S\+BI}的异常/中断初始化函数 \end{DoxyCompactList}\item 
void \mbox{\hyperlink{strap_8h_aac87713a691e1d0ff3762661d66f7b2c}{delegate\+\_\+traps}} (void)
\begin{DoxyCompactList}\small\item\em {\ttfamily delegate\+\_\+traps}用于将{\ttfamily M模式}下的一些中断和异常委托至{\ttfamily S模式} \end{DoxyCompactList}\item 
void \mbox{\hyperlink{strap_8h_adf9cc8a8a5e27e4814bf087b6958610d}{strap\+\_\+dispatcher}} (\mbox{\hyperlink{trapframe_8h_ace23faaa1579bcc09327b838e4f18145}{strapframe\+\_\+t}} $\ast$stf\+\_\+ptr)
\begin{DoxyCompactList}\small\item\em {\ttfamily strap\+\_\+dispatcher}是通用异常/中断处理函数, 将会根据{\ttfamily mcause}寄存器的值运行不同的中断处理函数 \end{DoxyCompactList}\item 
void \mbox{\hyperlink{strap_8h_a5654c6980aafe460d534d0bcc5c48348}{regitser\+\_\+strap\+\_\+handler}} (\mbox{\hyperlink{types_8h_aa232ecf786a74ce5363c36c10798d2b1}{uint64\+\_\+t}} trap\+\_\+code, \mbox{\hyperlink{types_8h_a253b248072cfc8bd812c69acd0046eed}{Bool}} interrupt, const char $\ast$msg, \mbox{\hyperlink{strap_8h_a9a19fa750573209f5634e474b11a3ee3}{strap\+\_\+handler\+\_\+t}} strap\+\_\+func)
\begin{DoxyCompactList}\small\item\em {\ttfamily regitser\+\_\+strap\+\_\+handler}是{\ttfamily S\+BI}异常/中断注册函数, 用于将编号为{\ttfamily trap\+\_\+code}的异常/中断的处理函数{\ttfamily strap\+\_\+func}注册到{\ttfamily S\+BI}的异常/中断处理函数表中 \end{DoxyCompactList}\item 
\mbox{\hyperlink{types_8h_a9bc43e3ee0ae83643b65e07fe1fd0132}{N\+O\+\_\+\+R\+E\+T\+U\+RN}} \mbox{\hyperlink{types_8h_a312c7e8848187d110315ab83a7b3d4d0}{int64\+\_\+t}} \mbox{\hyperlink{strap_8h_a55448a7c09442246934cc61d542749a4}{general\+\_\+strap\+\_\+handler}} (\mbox{\hyperlink{trapframe_8h_ace23faaa1579bcc09327b838e4f18145}{strapframe\+\_\+t}} $\ast$stf\+\_\+ptr)
\begin{DoxyCompactList}\small\item\em {\ttfamily general\+\_\+strap\+\_\+handler}是所有中断/异常的缺省处理函数, 将会在屏幕上输出中断/异常信息, 打印陷入帧, 而后挂起内核 \end{DoxyCompactList}\end{DoxyCompactItemize}


\doxysubsection{详细描述}
{\ttfamily \mbox{\hyperlink{strap_8h}{strap.\+h}}}是{\ttfamily S\+BI}的异常/中断管理模块 

\begin{DoxyAuthor}{作者}
Shihong Wang (\href{mailto:jack4shihong@gmail.com}{\texttt{ jack4shihong@gmail.\+com}}) 
\end{DoxyAuthor}
\begin{DoxyVersion}{版本}
0.\+1 
\end{DoxyVersion}
\begin{DoxyDate}{日期}
2023-\/04-\/15
\end{DoxyDate}
\begin{DoxyCopyright}{版权所有}
Copyright Shihong Wang (c) 2023 with G\+NU Public License V3.\+0 
\end{DoxyCopyright}


\doxysubsection{类型定义说明}
\mbox{\Hypertarget{strap_8h_a9a19fa750573209f5634e474b11a3ee3}\label{strap_8h_a9a19fa750573209f5634e474b11a3ee3}} 
\index{strap.h@{strap.h}!strap\_handler\_t@{strap\_handler\_t}}
\index{strap\_handler\_t@{strap\_handler\_t}!strap.h@{strap.h}}
\doxysubsubsection{\texorpdfstring{strap\_handler\_t}{strap\_handler\_t}}
{\footnotesize\ttfamily typedef \mbox{\hyperlink{types_8h_a312c7e8848187d110315ab83a7b3d4d0}{int64\+\_\+t}}($\ast$ strap\+\_\+handler\+\_\+t) (\mbox{\hyperlink{trapframe_8h_ace23faaa1579bcc09327b838e4f18145}{strapframe\+\_\+t}} $\ast$stf\+\_\+ptr)}



{\ttfamily strap\+\_\+handler\+\_\+t}是异常/中断处理函数的函数类型, 函数原型为\+: {\ttfamily int64\+\_\+t funcname(struct strapframe\+\_\+t$\ast$)} 


\begin{DoxyParams}{参数}
{\em stf\+\_\+ptr} & 指向被打断的程序的陷入帧, 程序的陷入帧将在{\ttfamily strap\+\_\+enter}中构建在{\ttfamily M模式}的栈中\\
\hline
\end{DoxyParams}
\begin{DoxyNote}{注解}
如果被打断的程序想要传参给异常/中断处理函数, 那么必须要通过寄存器来实现, 而所有的通用寄存器在{\ttfamily strap\+\_\+enter}函数中会被保存到陷入帧中. 所以异常/中断处理函数必然可以通过陷入栈来获得被打断的程序传入的参数

R\+I\+S\+C-\/\+V通过{\ttfamily a0$\sim$a7}寄存器传参, 因此在{\ttfamily strap\+\_\+enter}中要把{\ttfamily strapframe}的地址保存到{\ttfamily a0}寄存器中 
\end{DoxyNote}


\doxysubsection{函数说明}
\mbox{\Hypertarget{strap_8h_aac87713a691e1d0ff3762661d66f7b2c}\label{strap_8h_aac87713a691e1d0ff3762661d66f7b2c}} 
\index{strap.h@{strap.h}!delegate\_traps@{delegate\_traps}}
\index{delegate\_traps@{delegate\_traps}!strap.h@{strap.h}}
\doxysubsubsection{\texorpdfstring{delegate\_traps()}{delegate\_traps()}}
{\footnotesize\ttfamily void delegate\+\_\+traps (\begin{DoxyParamCaption}\item[{void}]{ }\end{DoxyParamCaption})}



{\ttfamily delegate\+\_\+traps}用于将{\ttfamily M模式}下的一些中断和异常委托至{\ttfamily S模式} 

\begin{DoxyNote}{注解}
目前将以下中断/异常进行了委托\+:
\begin{DoxyEnumerate}
\item 软件中断, 时钟中断, 外部中断
\item 指令未对齐异常, 读取指令页异常, 读取数据页异常, 存储数据页异常, 读取数据异常, 存储数据异常, 断点异常, U模式下的ecall异常
\end{DoxyEnumerate}


\begin{DoxyEnumerate}
\item 委托中断和异常本质上就是读写{\ttfamily mideleg}和{\ttfamily medeleg}寄存器. 这两个寄存器每一位对应一种中断/异常
\item 设置{\ttfamily mideleg}和{\ttfamily medeleg}寄存器对应的位后, 对应的中断/异常发生后就会进入到{\ttfamily ktrap\+\_\+enter}中
\item 这两个寄存器每一位具体操作的是什么中断/异常, 参考\+R\+I\+S\+C-\/\+V手册\+: 3.\+1.\+8 Machine Trap Delegation Registers (medeleg and mideleg) 
\end{DoxyEnumerate}
\end{DoxyNote}
\mbox{\Hypertarget{strap_8h_a55448a7c09442246934cc61d542749a4}\label{strap_8h_a55448a7c09442246934cc61d542749a4}} 
\index{strap.h@{strap.h}!general\_strap\_handler@{general\_strap\_handler}}
\index{general\_strap\_handler@{general\_strap\_handler}!strap.h@{strap.h}}
\doxysubsubsection{\texorpdfstring{general\_strap\_handler()}{general\_strap\_handler()}}
{\footnotesize\ttfamily \mbox{\hyperlink{types_8h_a9bc43e3ee0ae83643b65e07fe1fd0132}{N\+O\+\_\+\+R\+E\+T\+U\+RN}} \mbox{\hyperlink{types_8h_a312c7e8848187d110315ab83a7b3d4d0}{int64\+\_\+t}} general\+\_\+strap\+\_\+handler (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{trapframe_8h_ace23faaa1579bcc09327b838e4f18145}{strapframe\+\_\+t}} $\ast$}]{stf\+\_\+ptr }\end{DoxyParamCaption})}



{\ttfamily general\+\_\+strap\+\_\+handler}是所有中断/异常的缺省处理函数, 将会在屏幕上输出中断/异常信息, 打印陷入帧, 而后挂起内核 


\begin{DoxyParams}{参数}
{\em stf\+\_\+ptr} & 保存被中断的程序上下文信息(所有通用寄存器和部分\+C\+S\+R寄存器)的陷入栈, 在{\ttfamily strap\+\_\+enter}中构建 \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{返回}
N\+O\+\_\+\+R\+E\+T\+U\+RN 该函数将挂起内核, 不会返回至内核继续运行 
\end{DoxyReturn}
\mbox{\Hypertarget{strap_8h_a5654c6980aafe460d534d0bcc5c48348}\label{strap_8h_a5654c6980aafe460d534d0bcc5c48348}} 
\index{strap.h@{strap.h}!regitser\_strap\_handler@{regitser\_strap\_handler}}
\index{regitser\_strap\_handler@{regitser\_strap\_handler}!strap.h@{strap.h}}
\doxysubsubsection{\texorpdfstring{regitser\_strap\_handler()}{regitser\_strap\_handler()}}
{\footnotesize\ttfamily void regitser\+\_\+strap\+\_\+handler (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{types_8h_aa232ecf786a74ce5363c36c10798d2b1}{uint64\+\_\+t}}}]{trap\+\_\+code,  }\item[{\mbox{\hyperlink{types_8h_a253b248072cfc8bd812c69acd0046eed}{Bool}}}]{interrupt,  }\item[{const char $\ast$}]{msg,  }\item[{\mbox{\hyperlink{strap_8h_a9a19fa750573209f5634e474b11a3ee3}{strap\+\_\+handler\+\_\+t}}}]{strap\+\_\+func }\end{DoxyParamCaption})}



{\ttfamily regitser\+\_\+strap\+\_\+handler}是{\ttfamily S\+BI}异常/中断注册函数, 用于将编号为{\ttfamily trap\+\_\+code}的异常/中断的处理函数{\ttfamily strap\+\_\+func}注册到{\ttfamily S\+BI}的异常/中断处理函数表中 


\begin{DoxyParams}{参数}
{\em trap\+\_\+code} & 注册的中断/异常的编号 \\
\hline
{\em interrupt} & 若为\+True, 则将处理函数注册为中断处理函数, 否则注册为异常处理函数 \\
\hline
{\em msg} & 中断的相关信息 \\
\hline
{\em strap\+\_\+func} & 中断/异常处理函数, 需要为类型{\ttfamily strap\+\_\+handler\+\_\+t}, 即函数原型需要为{\ttfamily int64\+\_\+t funcname(ireg\+\_\+t mcause)} \\
\hline
\end{DoxyParams}
\mbox{\Hypertarget{strap_8h_adf9cc8a8a5e27e4814bf087b6958610d}\label{strap_8h_adf9cc8a8a5e27e4814bf087b6958610d}} 
\index{strap.h@{strap.h}!strap\_dispatcher@{strap\_dispatcher}}
\index{strap\_dispatcher@{strap\_dispatcher}!strap.h@{strap.h}}
\doxysubsubsection{\texorpdfstring{strap\_dispatcher()}{strap\_dispatcher()}}
{\footnotesize\ttfamily void strap\+\_\+dispatcher (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{trapframe_8h_ace23faaa1579bcc09327b838e4f18145}{strapframe\+\_\+t}} $\ast$}]{stf\+\_\+ptr }\end{DoxyParamCaption})}



{\ttfamily strap\+\_\+dispatcher}是通用异常/中断处理函数, 将会根据{\ttfamily mcause}寄存器的值运行不同的中断处理函数 


\begin{DoxyParams}{参数}
{\em stf\+\_\+ptr} & 保存被中断的程序上下文信息(所有通用寄存器和部分\+C\+S\+R寄存器)的陷入栈, 在{\ttfamily strap\+\_\+enter}中构建 \\
\hline
\end{DoxyParams}
