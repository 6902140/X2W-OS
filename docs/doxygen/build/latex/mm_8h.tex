\hypertarget{mm_8h}{}\doxysection{/home/data/proj/oskernel2023-\/x2w/include/mm.h 文件参考}
\label{mm_8h}\index{/home/data/proj/oskernel2023-\/x2w/include/mm.h@{/home/data/proj/oskernel2023-\/x2w/include/mm.h}}


{\ttfamily \mbox{\hyperlink{mm_8h}{mm.\+h}}}提供了一些内存管理需要的宏和函数.  


{\ttfamily \#include \char`\"{}pgable.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ptregs.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}stdbitmap.\+h\char`\"{}}\newline
\doxysubsection*{类}
\begin{DoxyCompactItemize}
\item 
struct \mbox{\hyperlink{struct____pool__t}{\+\_\+\+\_\+pool\+\_\+t}}
\begin{DoxyCompactList}\small\item\em 定义内存池的数据结构 \end{DoxyCompactList}\item 
struct \mbox{\hyperlink{struct____virtual__addr__t}{\+\_\+\+\_\+virtual\+\_\+addr\+\_\+t}}
\begin{DoxyCompactList}\small\item\em 定义虚拟地址池的数据结构 \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsection*{宏定义}
\begin{DoxyCompactItemize}
\item 
\#define \mbox{\hyperlink{mm_8h_a850d80ca2291d26b40dc6b25c419f81a}{P\+A\+G\+E\+\_\+\+S\+H\+I\+FT}}~12
\begin{DoxyCompactList}\small\item\em 页内偏移在虚拟地址中有12位 \end{DoxyCompactList}\item 
\#define \mbox{\hyperlink{mm_8h_a61113da663120ff8a3e513f3fa77b74b}{T\+A\+B\+L\+E\+\_\+\+S\+H\+I\+FT}}~9
\begin{DoxyCompactList}\small\item\em 一个页表的偏移在虚拟地址中9位偏移 \end{DoxyCompactList}\item 
\#define \mbox{\hyperlink{mm_8h_a7d467c1d283fdfa1f2081ba1e0d01b6e}{P\+A\+G\+E\+\_\+\+S\+I\+ZE}}~(1 $<$$<$ \mbox{\hyperlink{mm_8h_a850d80ca2291d26b40dc6b25c419f81a}{P\+A\+G\+E\+\_\+\+S\+H\+I\+FT}})
\begin{DoxyCompactList}\small\item\em 一个页的大小（2$^\wedge$12bit） \end{DoxyCompactList}\item 
\mbox{\Hypertarget{mm_8h_ae4aa620ce57c7c3171b916de2c5f09f2}\label{mm_8h_ae4aa620ce57c7c3171b916de2c5f09f2}} 
\#define {\bfseries P\+A\+G\+E\+\_\+\+M\+A\+SK}~($\sim$(\mbox{\hyperlink{mm_8h_a7d467c1d283fdfa1f2081ba1e0d01b6e}{P\+A\+G\+E\+\_\+\+S\+I\+ZE}}-\/1))
\item 
\#define \mbox{\hyperlink{mm_8h_a573f7d87a906903bec10256e19a8bb14}{P\+A\+G\+E\+\_\+\+A\+L\+I\+GN}}(addr)~(((addr)+\mbox{\hyperlink{mm_8h_a7d467c1d283fdfa1f2081ba1e0d01b6e}{P\+A\+G\+E\+\_\+\+S\+I\+ZE}}-\/1)\&P\+A\+G\+E\+\_\+\+M\+A\+SK)
\begin{DoxyCompactList}\small\item\em 将一个地址使用\+P\+A\+G\+E\+\_\+\+M\+A\+S\+K来进行地址对齐 \end{DoxyCompactList}\item 
\mbox{\Hypertarget{mm_8h_a632f076bc583efc1a8c6ec395b5a16c5}\label{mm_8h_a632f076bc583efc1a8c6ec395b5a16c5}} 
\#define {\bfseries P\+A\+G\+E\+\_\+\+A\+L\+I\+G\+N\+\_\+\+UP}(addr)~\mbox{\hyperlink{mm_8h_a573f7d87a906903bec10256e19a8bb14}{P\+A\+G\+E\+\_\+\+A\+L\+I\+GN}}(addr)
\item 
\mbox{\Hypertarget{mm_8h_a9c6658a67e8fe0f75b10a65026dcc339}\label{mm_8h_a9c6658a67e8fe0f75b10a65026dcc339}} 
\#define {\bfseries P\+A\+G\+E\+\_\+\+A\+L\+I\+G\+N\+\_\+\+D\+O\+WN}(addr)~(addr \& P\+A\+G\+E\+\_\+\+M\+A\+SK)
\item 
\mbox{\Hypertarget{mm_8h_afa9f78fa0aef0c17bc6cd364396b9758}\label{mm_8h_afa9f78fa0aef0c17bc6cd364396b9758}} 
\#define {\bfseries P\+F\+N\+\_\+\+D\+O\+WN}(x)~((x) $>$$>$ \mbox{\hyperlink{mm_8h_a850d80ca2291d26b40dc6b25c419f81a}{P\+A\+G\+E\+\_\+\+S\+H\+I\+FT}})
\item 
\#define \mbox{\hyperlink{mm_8h_a267933de1f2afc9011d648dba57ff988}{K\+\_\+\+H\+E\+A\+P\+\_\+\+S\+T\+A\+RT}}~0x\+C0100000
\begin{DoxyCompactList}\small\item\em 定义一个虚拟内存空间的起始地址 \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsection*{类型定义}
\begin{DoxyCompactItemize}
\item 
typedef struct \mbox{\hyperlink{struct____pool__t}{\+\_\+\+\_\+pool\+\_\+t}} \mbox{\hyperlink{mm_8h_ab4e8bc202de3328ef1923785bfff3065}{pool\+\_\+t}}
\begin{DoxyCompactList}\small\item\em 定义内存池的数据结构 \end{DoxyCompactList}\item 
typedef struct \mbox{\hyperlink{struct____virtual__addr__t}{\+\_\+\+\_\+virtual\+\_\+addr\+\_\+t}} \mbox{\hyperlink{mm_8h_ae6d40484ded75529eb862b9cc832b98f}{virtual\+\_\+addr\+\_\+t}}
\begin{DoxyCompactList}\small\item\em 定义虚拟地址池的数据结构 \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsection*{函数}
\begin{DoxyCompactItemize}
\item 
void \mbox{\hyperlink{mm_8h_a0652f9c27490845217db5f3400a0f12c}{paging\+\_\+init}} (void)
\begin{DoxyCompactList}\small\item\em 开启分页制度的初始化函数 \end{DoxyCompactList}\item 
void \mbox{\hyperlink{mm_8h_a1c9a66240fe216250e52d6b6e80dd798}{enable\+\_\+mmu\+\_\+relocate}} (void)
\begin{DoxyCompactList}\small\item\em 开启三级分页\+S\+V39的使能函数 \end{DoxyCompactList}\item 
unsigned long \mbox{\hyperlink{mm_8h_af5beb0578c75971eb353cd8a67e9c042}{get\+\_\+free\+\_\+page}} (void)
\begin{DoxyCompactList}\small\item\em 分配一个物理页 \end{DoxyCompactList}\item 
void \mbox{\hyperlink{mm_8h_a409722b58dcb786ea7ed28c9e2445912}{free\+\_\+page}} (unsigned long p)
\begin{DoxyCompactList}\small\item\em 释放一个物理页 \end{DoxyCompactList}\item 
void \mbox{\hyperlink{mm_8h_a35c4527cff3f92290891f1b1defefd0c}{mem\+\_\+init}} (unsigned long start\+\_\+mem, unsigned long end\+\_\+mem)
\begin{DoxyCompactList}\small\item\em 内存初始化函数，在其中实现了各种内存池的管理，位图的初始化，内存空间的统计等任务 \end{DoxyCompactList}\item 
void \mbox{\hyperlink{mm_8h_ad885b41f536f9dea88afcb34406fbbe9}{\+\_\+\+\_\+create\+\_\+pgd\+\_\+mapping}} (\mbox{\hyperlink{structpgd__t}{pgd\+\_\+t}} $\ast$pgdir, unsigned long phys, unsigned long virt, unsigned long size, \mbox{\hyperlink{structpgprot__t}{pgprot\+\_\+t}} prot, unsigned long($\ast$alloc\+\_\+pgtable)(void), unsigned long flags)
\begin{DoxyCompactList}\small\item\em P\+G\+D内存映射函数 \end{DoxyCompactList}\item 
\mbox{\Hypertarget{mm_8h_aecfb3f0bcce40e78a581b9ea34be214b}\label{mm_8h_aecfb3f0bcce40e78a581b9ea34be214b}} 
void {\bfseries set\+\_\+stage2\+\_\+page\+\_\+mapping} (unsigned long gpa, unsigned long hpa, unsigned long size, \mbox{\hyperlink{structpgprot__t}{pgprot\+\_\+t}} prot)
\item 
\mbox{\Hypertarget{mm_8h_ad3e379de9f5a1584f07a916fc7fec756}\label{mm_8h_ad3e379de9f5a1584f07a916fc7fec756}} 
void {\bfseries write\+\_\+stage2\+\_\+pg\+\_\+reg} (void)
\item 
\mbox{\Hypertarget{mm_8h_a3c40388c467d2f7e9fd4572d13487209}\label{mm_8h_a3c40388c467d2f7e9fd4572d13487209}} 
void {\bfseries stage2\+\_\+page\+\_\+fault} (struct \mbox{\hyperlink{structpt__regs}{pt\+\_\+regs}} $\ast$regs)
\end{DoxyCompactItemize}


\doxysubsection{详细描述}
{\ttfamily \mbox{\hyperlink{mm_8h}{mm.\+h}}}提供了一些内存管理需要的宏和函数. 

\begin{DoxyAuthor}{作者}
Zhuir Xiao (\href{mailto:xzr3356142450@gmail.com}{\texttt{ xzr3356142450@gmail.\+com}}) 
\end{DoxyAuthor}
\begin{DoxyVersion}{版本}
0.\+1 
\end{DoxyVersion}
\begin{DoxyDate}{日期}
2023-\/04-\/26
\end{DoxyDate}
\begin{DoxyRefDesc}{待办事项}
\item[\mbox{\hyperlink{todo__todo000001}{待办事项}}]
\begin{DoxyEnumerate}
\item 需要进行测试, 以测试函数正确性(已经在test\+\_\+memory.\+c中完成)
\end{DoxyEnumerate}\end{DoxyRefDesc}


\begin{DoxyWarning}{警告}

\end{DoxyWarning}
\begin{DoxyCopyright}{版权所有}
Copyright Zhuiri Xiao (c) 2023 with G\+NU Public License V3.\+0 
\end{DoxyCopyright}


\doxysubsection{宏定义说明}
\mbox{\Hypertarget{mm_8h_a267933de1f2afc9011d648dba57ff988}\label{mm_8h_a267933de1f2afc9011d648dba57ff988}} 
\index{mm.h@{mm.h}!K\_HEAP\_START@{K\_HEAP\_START}}
\index{K\_HEAP\_START@{K\_HEAP\_START}!mm.h@{mm.h}}
\doxysubsubsection{\texorpdfstring{K\_HEAP\_START}{K\_HEAP\_START}}
{\footnotesize\ttfamily \#define K\+\_\+\+H\+E\+A\+P\+\_\+\+S\+T\+A\+RT~0x\+C0100000}



定义一个虚拟内存空间的起始地址 

\mbox{\Hypertarget{mm_8h_a573f7d87a906903bec10256e19a8bb14}\label{mm_8h_a573f7d87a906903bec10256e19a8bb14}} 
\index{mm.h@{mm.h}!PAGE\_ALIGN@{PAGE\_ALIGN}}
\index{PAGE\_ALIGN@{PAGE\_ALIGN}!mm.h@{mm.h}}
\doxysubsubsection{\texorpdfstring{PAGE\_ALIGN}{PAGE\_ALIGN}}
{\footnotesize\ttfamily \#define P\+A\+G\+E\+\_\+\+A\+L\+I\+GN(\begin{DoxyParamCaption}\item[{}]{addr }\end{DoxyParamCaption})~(((addr)+\mbox{\hyperlink{mm_8h_a7d467c1d283fdfa1f2081ba1e0d01b6e}{P\+A\+G\+E\+\_\+\+S\+I\+ZE}}-\/1)\&P\+A\+G\+E\+\_\+\+M\+A\+SK)}



将一个地址使用\+P\+A\+G\+E\+\_\+\+M\+A\+S\+K来进行地址对齐 

\mbox{\Hypertarget{mm_8h_a850d80ca2291d26b40dc6b25c419f81a}\label{mm_8h_a850d80ca2291d26b40dc6b25c419f81a}} 
\index{mm.h@{mm.h}!PAGE\_SHIFT@{PAGE\_SHIFT}}
\index{PAGE\_SHIFT@{PAGE\_SHIFT}!mm.h@{mm.h}}
\doxysubsubsection{\texorpdfstring{PAGE\_SHIFT}{PAGE\_SHIFT}}
{\footnotesize\ttfamily \#define P\+A\+G\+E\+\_\+\+S\+H\+I\+FT~12}



页内偏移在虚拟地址中有12位 

\mbox{\Hypertarget{mm_8h_a7d467c1d283fdfa1f2081ba1e0d01b6e}\label{mm_8h_a7d467c1d283fdfa1f2081ba1e0d01b6e}} 
\index{mm.h@{mm.h}!PAGE\_SIZE@{PAGE\_SIZE}}
\index{PAGE\_SIZE@{PAGE\_SIZE}!mm.h@{mm.h}}
\doxysubsubsection{\texorpdfstring{PAGE\_SIZE}{PAGE\_SIZE}}
{\footnotesize\ttfamily \#define P\+A\+G\+E\+\_\+\+S\+I\+ZE~(1 $<$$<$ \mbox{\hyperlink{mm_8h_a850d80ca2291d26b40dc6b25c419f81a}{P\+A\+G\+E\+\_\+\+S\+H\+I\+FT}})}



一个页的大小（2$^\wedge$12bit） 

\mbox{\Hypertarget{mm_8h_a61113da663120ff8a3e513f3fa77b74b}\label{mm_8h_a61113da663120ff8a3e513f3fa77b74b}} 
\index{mm.h@{mm.h}!TABLE\_SHIFT@{TABLE\_SHIFT}}
\index{TABLE\_SHIFT@{TABLE\_SHIFT}!mm.h@{mm.h}}
\doxysubsubsection{\texorpdfstring{TABLE\_SHIFT}{TABLE\_SHIFT}}
{\footnotesize\ttfamily \#define T\+A\+B\+L\+E\+\_\+\+S\+H\+I\+FT~9}



一个页表的偏移在虚拟地址中9位偏移 



\doxysubsection{类型定义说明}
\mbox{\Hypertarget{mm_8h_ab4e8bc202de3328ef1923785bfff3065}\label{mm_8h_ab4e8bc202de3328ef1923785bfff3065}} 
\index{mm.h@{mm.h}!pool\_t@{pool\_t}}
\index{pool\_t@{pool\_t}!mm.h@{mm.h}}
\doxysubsubsection{\texorpdfstring{pool\_t}{pool\_t}}
{\footnotesize\ttfamily typedef struct \mbox{\hyperlink{struct____pool__t}{\+\_\+\+\_\+pool\+\_\+t}} \mbox{\hyperlink{mm_8h_ab4e8bc202de3328ef1923785bfff3065}{pool\+\_\+t}}}



定义内存池的数据结构 

\begin{DoxyNote}{注解}
包含 ~\newline
 pool\+\_\+bitmap; 本内存池的位图，用于管理物理内存 phy\+\_\+addr\+\_\+start; 本内存池所管理的物理内存的起始地址 pool\+\_\+size; 本内存池的字节容量 mutex\+\_\+t mutex; 用于实现互斥访问内存池暂时没有实现 ~\newline
 
\end{DoxyNote}
\mbox{\Hypertarget{mm_8h_ae6d40484ded75529eb862b9cc832b98f}\label{mm_8h_ae6d40484ded75529eb862b9cc832b98f}} 
\index{mm.h@{mm.h}!virtual\_addr\_t@{virtual\_addr\_t}}
\index{virtual\_addr\_t@{virtual\_addr\_t}!mm.h@{mm.h}}
\doxysubsubsection{\texorpdfstring{virtual\_addr\_t}{virtual\_addr\_t}}
{\footnotesize\ttfamily typedef struct \mbox{\hyperlink{struct____virtual__addr__t}{\+\_\+\+\_\+virtual\+\_\+addr\+\_\+t}} \mbox{\hyperlink{mm_8h_ae6d40484ded75529eb862b9cc832b98f}{virtual\+\_\+addr\+\_\+t}}}



定义虚拟地址池的数据结构 

\begin{DoxyNote}{注解}
包含 ~\newline
 vaddr\+\_\+bitmap; 虚拟内存的位图 vaddr\+\_\+start; 虚拟内存的起始的物理地址 ~\newline
 
\end{DoxyNote}


\doxysubsection{函数说明}
\mbox{\Hypertarget{mm_8h_ad885b41f536f9dea88afcb34406fbbe9}\label{mm_8h_ad885b41f536f9dea88afcb34406fbbe9}} 
\index{mm.h@{mm.h}!\_\_create\_pgd\_mapping@{\_\_create\_pgd\_mapping}}
\index{\_\_create\_pgd\_mapping@{\_\_create\_pgd\_mapping}!mm.h@{mm.h}}
\doxysubsubsection{\texorpdfstring{\_\_create\_pgd\_mapping()}{\_\_create\_pgd\_mapping()}}
{\footnotesize\ttfamily void \+\_\+\+\_\+create\+\_\+pgd\+\_\+mapping (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{structpgd__t}{pgd\+\_\+t}} $\ast$}]{pgdir,  }\item[{unsigned long}]{phys,  }\item[{unsigned long}]{virt,  }\item[{unsigned long}]{size,  }\item[{\mbox{\hyperlink{structpgprot__t}{pgprot\+\_\+t}}}]{prot,  }\item[{unsigned long($\ast$)(void)}]{alloc\+\_\+pgtable,  }\item[{unsigned long}]{flags }\end{DoxyParamCaption})}



P\+G\+D内存映射函数 

\begin{DoxyNote}{注解}
该函数会： 1：输入的虚拟地址和物理地址还有要映射的内存大小填充\+P\+G\+D表项 2\+: 将一段物理内存映射到一个指定的虚拟地址范围内。具体实现是通过对虚拟地址进行对齐和分割，逐个处理每个\+P\+G\+D表项，并将其指向相应的\+P\+M\+D表项来实现对整个虚拟地址范围的映射。在映射的过程中，函数还会调用alloc\+\_\+init\+\_\+pmd()函数，为每个\+P\+M\+D表项分配并初始化一个物理页面。该函数的参数包括\+P\+G\+D表基地址、需要映射的物理地址、虚拟地址、大小、保护标志、分配函数、标志等。 
\end{DoxyNote}
\mbox{\Hypertarget{mm_8h_a1c9a66240fe216250e52d6b6e80dd798}\label{mm_8h_a1c9a66240fe216250e52d6b6e80dd798}} 
\index{mm.h@{mm.h}!enable\_mmu\_relocate@{enable\_mmu\_relocate}}
\index{enable\_mmu\_relocate@{enable\_mmu\_relocate}!mm.h@{mm.h}}
\doxysubsubsection{\texorpdfstring{enable\_mmu\_relocate()}{enable\_mmu\_relocate()}}
{\footnotesize\ttfamily void enable\+\_\+mmu\+\_\+relocate (\begin{DoxyParamCaption}\item[{void}]{ }\end{DoxyParamCaption})}



开启三级分页\+S\+V39的使能函数 

\begin{DoxyNote}{注解}
实现在kernel/mmu\+\_\+enable中使用汇编语言实现 
\end{DoxyNote}
\mbox{\Hypertarget{mm_8h_a409722b58dcb786ea7ed28c9e2445912}\label{mm_8h_a409722b58dcb786ea7ed28c9e2445912}} 
\index{mm.h@{mm.h}!free\_page@{free\_page}}
\index{free\_page@{free\_page}!mm.h@{mm.h}}
\doxysubsubsection{\texorpdfstring{free\_page()}{free\_page()}}
{\footnotesize\ttfamily void free\+\_\+page (\begin{DoxyParamCaption}\item[{unsigned long}]{p }\end{DoxyParamCaption})}



释放一个物理页 

\begin{DoxyNote}{注解}
该函数会 1：根据输入的物理地址释放一个位 2：设置位图相应位为0 
\end{DoxyNote}
\mbox{\Hypertarget{mm_8h_af5beb0578c75971eb353cd8a67e9c042}\label{mm_8h_af5beb0578c75971eb353cd8a67e9c042}} 
\index{mm.h@{mm.h}!get\_free\_page@{get\_free\_page}}
\index{get\_free\_page@{get\_free\_page}!mm.h@{mm.h}}
\doxysubsubsection{\texorpdfstring{get\_free\_page()}{get\_free\_page()}}
{\footnotesize\ttfamily unsigned long get\+\_\+free\+\_\+page (\begin{DoxyParamCaption}\item[{void}]{ }\end{DoxyParamCaption})}



分配一个物理页 

\begin{DoxyNote}{注解}
该函数会 1：扫描kernel的bitmap然后返回一个空闲的物理地址 2： 将bitmap相应位置设置为1 3：暂未使用🔒保护，因为互斥机制还未实现 
\end{DoxyNote}
\mbox{\Hypertarget{mm_8h_a35c4527cff3f92290891f1b1defefd0c}\label{mm_8h_a35c4527cff3f92290891f1b1defefd0c}} 
\index{mm.h@{mm.h}!mem\_init@{mem\_init}}
\index{mem\_init@{mem\_init}!mm.h@{mm.h}}
\doxysubsubsection{\texorpdfstring{mem\_init()}{mem\_init()}}
{\footnotesize\ttfamily void mem\+\_\+init (\begin{DoxyParamCaption}\item[{unsigned long}]{start\+\_\+mem,  }\item[{unsigned long}]{end\+\_\+mem }\end{DoxyParamCaption})}



内存初始化函数，在其中实现了各种内存池的管理，位图的初始化，内存空间的统计等任务 

\begin{DoxyNote}{注解}
该函数会： 1：根据初始内存管理地址start\+\_\+mem，内存管理终止地址end\+\_\+mem来统计内存大小，页数... 2\+: 初始化各种内存池以及位图 
\end{DoxyNote}
\mbox{\Hypertarget{mm_8h_a0652f9c27490845217db5f3400a0f12c}\label{mm_8h_a0652f9c27490845217db5f3400a0f12c}} 
\index{mm.h@{mm.h}!paging\_init@{paging\_init}}
\index{paging\_init@{paging\_init}!mm.h@{mm.h}}
\doxysubsubsection{\texorpdfstring{paging\_init()}{paging\_init()}}
{\footnotesize\ttfamily void paging\+\_\+init (\begin{DoxyParamCaption}\item[{void}]{ }\end{DoxyParamCaption})}



开启分页制度的初始化函数 

\begin{DoxyNote}{注解}
该函数会 1：建立一个\+P\+G\+D页，然后将其清空 2：根据mem\+\_\+init()统计得到的内存的信息在内存空间先建立三级页表 3：建立分页机制之后使能mmu模块 
\end{DoxyNote}
